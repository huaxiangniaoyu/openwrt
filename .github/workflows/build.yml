name: Build kwt for JDCloud RE-CS-05 with Docker & PassWall

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200

    steps:
    - name: Checkout with retry
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
      continue-on-error: true

    - name: Retry checkout if failed
      if: failure()
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive

    - name: ğŸ“¦ Install System Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3-distutils rsync subversion \
          swig time unzip wget python3 python3-pip python3-ply \
          haveged lrzsz libc6-dev libstdc++6

    - name: ğŸš€ Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: jdcloud-re-cs-05-docker-passwall

    - name: ğŸŒ± Update & Install Feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ğŸ›  Generate .config for RE-CS-05 with Plugins
      run: |
        rm -f .config

        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_jingdong_re-cs-05=y" >> .config

        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config

        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_v2ray-core=y" >> .config

        echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
        echo "CONFIG_PACKAGE_docker=y" >> .config
        echo "CONFIG_PACKAGE_dockerd=y" >> .config

        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config

        make defconfig

    - name: ğŸ—ï¸ Start Compilation
      run: |
        make -j$(nproc) V=s

    - name: ğŸ“¤ Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kwt-jdcloud-re-cs-05-docker-passwall
        path: |
          bin/targets/mediatek/filogic/*jingdong-re-cs-05-squashfs-sysupgrade.bin
          bin/targets/mediatek/filogic/sha256sums
