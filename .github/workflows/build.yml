name: Build kwt for JDCloud RE-CS-05 with Docker & PassWall

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200  # æœ€å¤š 3 å°æ—¶ 20 åˆ†é’Ÿ

    steps:
      - name: â³ Checkout Source Code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ“¦ Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3-distutils rsync subversion \
            swig time unzip wget python3 python3-pip python3-ply \
            haveged lrzsz libc6-dev libstdc++6

      - name: ğŸš€ Setup ccache (Speed up future builds)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: jdcloud-re-cs-05-docker-passwall

      - name: ğŸŒ± Update & Install Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ›  Generate .config for RE-CS-05 with Plugins
        run: |
          rm -f .config

          # === åŸºç¡€å¹³å° ===
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_jingdong_re-cs-05=y" >> .config

          # === LuCI Web ç•Œé¢ ===
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-system=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-network=y" >> .config
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config

          # === PassWall ç§‘å­¦ä¸Šç½‘ ===
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_chinadns-ng=y" >> .config
          echo "CONFIG_PACKAGE_v2ray-core=y" >> .config
          echo "CONFIG_PACKAGE_trojan-go=y" >> .config

          # === Docker (Dockerman) ===
          echo "CONFIG_PACKAGE_luci-app-dockerman=y" >> .config
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_dockerd=y" >> .config
          echo "CONFIG_PACKAGE_containerd=y" >> .config

          # === AdGuard Home å¹¿å‘Šè¿‡æ»¤ ===
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          echo "CONFIG_PACKAGE_adguardhome=y" >> .config

          # === USB & æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼ˆDocker éœ€è¦å¤–æ¥å­˜å‚¨ï¼‰===
          echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
          echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
          echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
          echo "CONFIG_PACKAGE_block-mount=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nls-cp437=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fs-ntfs3=y" >> .config  # NTFS è¯»å†™æ”¯æŒ

          # === å…¶ä»–å®ç”¨å·¥å…· ===
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
          echo "CONFIG_PACKAGE_wget-ssl=y" >> .config

          # ç”Ÿæˆå®Œæ•´é…ç½®
          make defconfig

      - name: ğŸ—ï¸ Start Compilation (è€å¿ƒç­‰å¾… 1.5~2 å°æ—¶)
        run: |
          make -j$(nproc) V=s

      - name: ğŸ“¤ Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kwt-jdcloud-re-cs-05-docker-passwall
          path: |
            bin/targets/mediatek/filogic/*jingdong-re-cs-05-squashfs-sysupgrade.bin
            bin/targets/mediatek/filogic/sha256sums
