name: Build kwt for JDCloud RE-CS-05 (Minimal + PassWall)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200  # æœ€å¤š 3 å°æ—¶ 20 åˆ†é’Ÿ

    steps:
    - name: ğŸ’¾ Check Disk Space (Before)
      run: df -h

    - name: â³ Checkout Source Code
      uses: actions/checkout@v4
      with:
        ref: master          # kiddin9/openwrt ä½¿ç”¨ master åˆ†æ”¯
        submodules: recursive
        fetch-depth: 0
      continue-on-error: true

    - name: ğŸ” Retry Checkout on Failure
      if: failure()
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive

    - name: ğŸ“¦ Install System Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3-distutils rsync subversion \
          swig time unzip wget python3 python3-pip python3-ply \
          haveged lrzsz libc6-dev libstdc++6

    - name: ğŸš€ Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: jdcloud-re-cs-05-minimal-passwall

    - name: ğŸŒ± Update & Install Feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ğŸ›  Generate .config (Optimized for RE-CS-05)
      run: |
        rm -f .config

        # === Target Platform ===
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_jingdong_re-cs-05=y" >> .config

        # === LuCI Web Interface ===
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config

        # === PassWall (Minimal Core) ===
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_v2ray-core=y" >> .config

        # === USB & Storage Support ===
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-scsi-core=y" >> .config
        echo "CONFIG_PACKAGE_block-mount=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config

        # === Essential Tools ===
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_wget-ssl=y" >> .config

        # === CRITICAL: Disable GDB to save RAM & time ===
        echo "CONFIG_GDB=n" >> .config
        echo "CONFIG_PACKAGE_gdb=n" >> .config

        # Generate final config
        make defconfig

    - name: ğŸ—ï¸ Compile Firmware (-j2 to avoid OOM)
      run: |
        echo "Starting compilation with -j2..."
        make -j2 V=s

    - name: ğŸ’¾ Check Disk Space (After)
      run: df -h

    - name: ğŸ“¤ Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kwt-jdcloud-re-cs-05-passwall-minimal
        path: |
          bin/targets/mediatek/filogic/*jingdong-re-cs-05-squashfs-sysupgrade.bin
          bin/targets/mediatek/filogic/sha256sums
